(function(){var f,i,p,m,k,r,n,s;"undefined"!==typeof require?(f=require("underscore"),i=require("backbone"),exports=module.exports=i):(f=this._,i=this.Backbone);p=i.Model;m=i.Collection;k=p.prototype;s=/[\.\[\]]+/g;r="change add remove reset destroy sync error sort request".split(" ");i.Many="Many";i.One="One";n=i.AssociatedModel=p.extend({relations:void 0,_proxyCalls:void 0,get:function(c){var a=k.get.call(this,c);return a?a:this.getAttr.apply(this,arguments)},set:function(c,a,d){var b,e,l,t,h=this;
if(f.isObject(c)||c==null){b=c;d=a}else{b={};b[c]=a}if(!b)return this;l||(l={});for(e in b)if(e.match(s)){c=q(e);a=f.initial(c);c=c[c.length-1];a=this.get(a);if(a instanceof n){a=l[a.cid]||(l[a.cid]={model:a,data:{}});a.data[c]=b[e]}}else{a=l[this.cid]||(l[this.cid]={model:this,data:{}});a.data[e]=b[e]}for(t in l){a=l[t];this.setAttr.call(a.model,a.data,d)||(h=false)}return h},setAttr:function(c,a){var d,b,e;a||(a={});if(a.unset)for(e in c)c[e]=void 0;this.relations&&f.each(this.relations,function(b){var e=
b.key,h=b.relatedModel,g=b.collectionType,j,o;if(c[e]){j=f.result(c,e);h&&f.isString(h)&&(h=eval(h));g&&f.isString(g)&&(g=eval(g));o=b.options?f.extend({},b.options,a):a;if(b.type===i.Many){if(g&&!g.prototype instanceof m)throw Error("collectionType must inherit from Backbone.Collection");if(j instanceof m)k.set.call(this,e,j,o);else if(this.attributes[e])this.attributes[e].reset(j,o);else{b=g?new g:this._createCollection(h);b.add(j,o);k.set.call(this,e,b,o)}}else if(b.type===i.One&&h){b=j instanceof
n?j:new h(j);k.set.call(this,e,b,o)}if((j=this.attributes[e])&&!j._proxyCallback){j._proxyCallback=function(){return this._bubbleEvent.call(this,e,arguments)};j.on("all",j._proxyCallback,this)}!d&&(d=[]);f.indexOf(d,e)===-1&&d.push(e)}},this);if(d){b={};for(e in c)f.indexOf(d,e)===-1&&(b[e]=c[e])}else b=c;return k.set.call(this,b,a)},_bubbleEvent:function(c,a){var d=a[0].split(":"),b=d[0],e=a[1],l=-1,i=this.attributes[c],h=i._proxyCalls,g;if(f.contains(r,b)){f.size(d)>1&&(g=d[1]);if(i instanceof m&&
"change"===b&&e){var j=q(g),k=f.initial(j);(d=i.find(function(a){var b=a.get(j);return e===(b instanceof n||b instanceof m)?b:a.get(k)||a}))&&(l=i.indexOf(d))}g=c+(l!==-1?"["+l+"]":"")+(g?"."+g:"");a[0]=b+":"+g;if(h){if(b=f.find(h,function(a,b){return g.indexOf(b,g.length-b.length)!==-1}))return this}else h=i._proxyCalls={};h[g]=true}this.trigger.apply(this,a);g&&h&&delete h[g];return this},_createCollection:function(c){var a=c;f.isString(a)&&(a=eval(a));if(a&&a.prototype instanceof n){c=new m;c.model=
a}else throw Error("type must inherit from Backbone.AssociatedModel");return c},hasChanged:function(c){var a,d,b;if(!this.visitedHC){this.visitedHC=true;a=k.hasChanged.apply(this,arguments);if(!a&&this.relations)for(b=0;b<this.relations.length;++b){d=this.relations[b];if(d=this.attributes[d.key]){if(d instanceof m){d=d.filter(function(a){return a.hasChanged()===true});f.size(d)>0&&(a=true)}else a=d.hasChanged&&d.hasChanged();if(a)break}}delete this.visitedHC}return a},changedAttributes:function(c){var a,
d,b,e;if(!this.visited){this.visited=true;a=k.changedAttributes.apply(this,arguments);if(this.relations)for(e=0;e<this.relations.length;++e){d=this.relations[e];if(b=this.attributes[d.key])if(b instanceof m){b=f.filter(b.map(function(a){return a.changedAttributes()}),function(a){return!!a});f.size(b)>0&&(a[d.key]=b)}else b instanceof n&&b.hasChanged()&&(a[d.key]=b.toJSON())}delete this.visited}return!a?false:a},previousAttributes:function(){var c,a,d,b;if(!this.visited){this.visited=true;c=k.previousAttributes.apply(this,
arguments);this.relations&&f.each(this.relations,function(e){a=this.attributes[e.key];b=(d=c[e.key])?d.toJSON():void 0;d&&d==a?a instanceof n?c[e.key]=a.previousAttributes():a instanceof m&&(c[e.key]=a.map(function(a){return a.previousAttributes()})):d&&(c[e.key]=b)},this);delete this.visited}return c},previous:function(c){return this.previousAttributes()[c]},toJSON:function(c){var a,d;if(!this.visited){this.visited=true;a=k.toJSON.apply(this,arguments);this.relations&&f.each(this.relations,function(b){var e=
this.attributes[b.key];if(e){d=e.toJSON(c);a[b.key]=f.isArray(d)?f.compact(d):d}},this);delete this.visited}return a},clone:function(){return new this.constructor(this.toJSON())},getAttr:function(c){var a=this,c=q(c),d,b;if(!(f.size(c)<1)){for(b=0;b<c.length;b++){d=c[b];if(!d)break;if(!a)break;a=a instanceof m&&!isNaN(d)?a.at(d):a.attributes[d]}return a}}});var u=/\.|\[|\]\.*/,q=function(c){return f.isString(c)?c.split(u):c||[""]}}).call(this);
