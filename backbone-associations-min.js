(function(){var e,d;"undefined"===typeof window?(e=require("underscore"),d=require("backbone"),exports=module.exports=d):(e=window._,d=window.Backbone,exports=window);d.Many="Many";d.One="One";d.AssociatedModel=d.Model.extend({relations:void 0,set:function(b,c,g){var f,h;e.isObject(b)||null==b?(f=b,g=c):(f={},f[b]=c);g||(g={});if(!f)return this;if(g.unset)for(attr in f)f[attr]=void 0;this.relations&&e.each(this.relations,function(a){if(void 0!=f[a.key]){var b=!f||!f[a.key]?null:e.isFunction(f[a.key])?
f[a.key]():f[a.key];a.relatedModel&&e.isString(a.relatedModel)&&(a.relatedModel=eval(a.relatedModel));a.collectionType&&e.isString(a.collectionType)&&(a.collectionType=eval(a.collectionType));var c=!1,i=g;void 0!=a.options&&e.extend(i,a.options);if(a.type===d.Many){if(a.collectionType&&!a.collectionType.prototype instanceof d.Collection)throw Error("collectionType must inherit from Backbone.Collection");this.attributes[a.key]||(this.attributes[a.key]=a.collectionType?new a.collectionType:this._createCollection(a.relatedModel),
c=!0);b instanceof d.Collection&&(b=b.models);this.attributes[a.key].reset(b,i)}else if(a.type==d.One&&a.relatedModel){if(this.attributes[a.key]){var j={},k=!this.attributes[a.key]||!this.attributes[a.key].defaults?null:e.isFunction(this.attributes[a.key].defaults)?this.attributes[a.key].defaults():this.attributes[a.key].defaults;e.each(this.attributes[a.key].attributes,function(a,c){!e.has(b,c)&&(j[c]=k?k[c]:void 0)});this.attributes[a.key].set(j,{silent:!0})}else{if(b instanceof d.AssociatedModel)return this;
this.attributes[a.key]=new a.relatedModel;c=!0}this.attributes[a.key].set(b,i)}this.attributes[a.key].off("all");this.attributes[a.key].on("all",function(){return this.trigger.apply(this,arguments)},this);c&&this.trigger("change:"+a.key);!h&&(h=[]);-1===e.indexOf(h,a.key)&&h.push(a.key)}},this);if(h)for(b in c={},f)-1===e.indexOf(h,b)&&(c[b]=f[b]);else c=f;return d.Model.prototype.set.call(this,c,g)},_createCollection:function(b){var c;if(b&&b.prototype instanceof d.AssociatedModel)c=new d.Collection,
c.model=b;else throw Error("type must inherit from Backbone.AssociatedModel");return c},trigger:function(){this.visited||(this.visited=!0,d.Model.prototype.trigger.apply(this,arguments),delete this.visited);return this},toJSON:function(){var b;this.visited||(this.visited=!0,b=d.Model.prototype.toJSON.apply(this,arguments),this.relations&&e.each(this.relations,function(c){var d=this.attributes[c.key];d&&(aJson=d.toJSON(),b[c.key]=e.isArray(aJson)?e.compact(aJson):aJson)},this),delete this.visited);
return b},clone:function(){var b;this.visited||(this.visited=!0,b=d.Model.prototype.clone.apply(this,arguments),this.relations&&e.each(this.relations,function(c){if(this.attributes[c.key]){var e=b.attributes[c.key];if(e instanceof d.Collection){var f=c.collectionType?new c.collectionType:this._createCollection(c.relatedModel);e.each(function(b){(b=b.clone())&&f.add(b)});b.attributes[c.key]=f}else e instanceof d.Model&&(b.attributes[c.key]=e.clone())}},this),delete this.visited);return b}})})();
